name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-mobile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Lint (mobile app)
        run: npm run lint

  lint-server:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Lint (server)
        run: npm run lint

  unit-tests:
    runs-on: ubuntu-latest
    needs: [lint-mobile, lint-server]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps (mobile)
        run: npm ci

      - name: Run mobile unit tests
        run: npm test -- --watch=false

      - name: Install deps (server)
        working-directory: server
        run: npm ci

      - name: Run server unit tests
        working-directory: server
        run: npm test

  e2e-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: server/package-lock.json

      - name: Install deps (server)
        working-directory: server
        run: npm ci

      - name: Run server e2e tests
        working-directory: server
        run: npm run test:e2e

  sast:
    runs-on: ubuntu-latest
    needs: [lint-mobile, lint-server]
    steps:
      - uses: actions/checkout@v4

      - name: Install Semgrep
        run: python -m pip install --upgrade pip && pip install semgrep

      - name: Run Semgrep SAST
        run: semgrep scan --config auto

  dependency-audit:
    runs-on: ubuntu-latest
    needs: [lint-mobile, lint-server]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: npm ci (root)
        run: npm ci

      - name: npm audit (root)
        run: npm audit --audit-level=moderate || true

      - name: npm ci (server)
        working-directory: server
        run: npm ci

      - name: npm audit (server)
        working-directory: server
        run: npm audit --audit-level=moderate || true

  web-ci:
    runs-on: ubuntu-latest
    needs: [lint-mobile, lint-server]
    defaults:
      run:
        working-directory: meetmate-web
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: meetmate-web/package-lock.json

      - name: npm ci (web)
        run: npm ci

      - name: Lint (web)
        run: npm run lint

      - name: Unit tests (web)
        run: npm run test

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: E2E tests (web)
        run: npm run test:e2e

      - name: npm audit (web)
        run: npm audit --audit-level=moderate || true
